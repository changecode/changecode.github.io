<!DOCTYPE html>
<!--[if lte IE 8 ]>
<html class="ie" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<![endif]-->
<!--[if (gte IE 9)|!(IE)]><!-->
<!--
***************  *      *     *
      8          *    *       *
      8          *  *         *
      8          **           *
      8          *  *         *
      8          *    *       *
      8          *      *     *
      8          *        *   ***********    -----Theme By Kieran(http://go.kieran.top)
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<!--<![endif]-->

<head>
  <title>DougLea_同步与Java内存模型 | 阿修罗</title>
  <!-- Meta data -->
    <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="generator" content="阿修罗">
    <meta name="author" content="changecode">
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <!-- Favicon, (keep icon in root folder) -->
    <link rel="Shortcut Icon" href="/img/favicon.ico" type="image/ico">

    <link rel="alternate" href="/atom.xml" title="阿修罗" type="application/atom+xml">
    <link rel="stylesheet" href="/css/all.css" media="screen" type="text/css">
    
    <link rel="stylesheet" href="/highlightjs/vs.css" type="text/css">
    

    <!--[if IE 8]>
    <link rel="stylesheet" type="text/css" href="/css/ie8.css" />
    <![endif]-->

    <!-- jQuery | Load our jQuery, with an alternative source fallback to a local version if request is unavailable -->
    <script src="/js/jquery-1.11.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="js/jquery-1.11.1.min.js"><\/script>')</script>

    <!-- Load these in the <head> for quicker IE8+ load times -->
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <![endif]-->

  
  
  

  <style>.col-md-8.col-md-offset-2.opening-statement img{display:none;}</style>
</head>

<!--
<body class="post-template">
-->
<body id="index" class="lightnav animsition">

      <!-- ============================ Off-canvas navigation =========================== -->

    <div class="sb-slidebar sb-right sb-style-overlay sb-momentum-scrolling">
        <div class="sb-close" aria-label="Close Menu" aria-hidden="true">
            <img src="/img/close.png" alt="Close"/>
        </div>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu">
            <li><a href="/" class="animsition-link" title="Home">Home</a></li>
            <li><a href="/archives" class="animsition-link" title="archive">archives</a></li>
            <!-- Dropdown Menu -->
			 
            
            
        </ul>
        <!-- Lists in Slidebars -->
        <ul class="sb-menu secondary">
            <li><a href="/about.html" class="animsition-link" title="about">About</a></li>
            <li><a href="/atom.xml" class="animsition-link" title="rss">RSS</a></li>
        </ul>
    </div>
    
    <!-- ============================ END Off-canvas navigation =========================== -->

    <!-- ============================ #sb-site Main Page Wrapper =========================== -->

    <div id="sb-site">
        <!-- #sb-site - All page content should be contained within this id, except the off-canvas navigation itself -->

        <!-- ============================ Header & Logo bar =========================== -->

        <div id="navigation" class="navbar navbar-fixed-top">
            <div class="navbar-inner">
                <div class="container">
                    <!-- Nav logo -->
                    <div class="logo">
                        <a href="/" title="Logo" class="animsition-link">
                         <img src="/img/logo.png" alt="Logo" width="35px;"/> 
                        </a>
                    </div>
                    <!-- // Nav logo -->
                    <!-- Info-bar -->
                    <nav>
                        <ul class="nav">
                            <li><a href="/" class="animsition-link">阿修罗</a></li>
                            <li class="nolink"><span>Always </span>Creative.</li>
                            
                            <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a></li>
                            
                            
                            
                            <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a></li>
                            
                            
                            <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a></li>
                            
                            
                            <li class="nolink"><span>Welcome!</span></li>
                        </ul>
                    </nav>
                    <!--// Info-bar -->
                </div>
                <!-- // .container -->
                <div class="learnmore sb-toggle-right">More</div>
                <button type="button" class="navbar-toggle menu-icon sb-toggle-right" title="More">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar before"></span>
                <span class="icon-bar main"></span>
                <span class="icon-bar after"></span>
                </button>
            </div>
            <!-- // .navbar-inner -->
        </div>

        <!-- ============================ Header & Logo bar =========================== -->


      
<section id="intro">
    <div class="container">
        <div class="row col-md-offset-2">
            <div class="col-md-8">
    			<span class="post-meta">
      <time datetime="2017-10-30T02:09:54.000Z" itemprop="datePublished">
          2017-10-30
      </time>
    
</span>
                <h1>DougLea_同步与Java内存模型</h1>
            </div>
        </div>
        <div class="col-md-8 col-md-offset-2">
      		<h1 id="同步与Java内存模型"><a href="#同步与Java内存模型" class="headerlink" title="同步与Java内存模型"></a>同步与Java内存模型</h1><h1 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h1><p>先看如下这个简单的Java类，该类中并没有使用同步</p>
<pre><code>final class SetCheck {
    private int a = 0;
    private long b = 0;

    void set() {
        a = 1;
        b = -1;
    }

    boolean check() {
        return ((b == 0) || (b == -1 &amp;&amp; 
            a == 1));
    }
}
</code></pre><p>如果是在一个串行执行的语言中，执行check方法永远不会<br>返回false，即使编译器，运行时和计算机硬件并没有按照<br>你所期望的逻辑来处理这段程序，该方法依然不会返回<br>false。在程序执行过程中，下面这些你所不能预料的行为<br>都是可能发生的<br>1 编译器可能会进行指令重排序，所以b变量的赋值操作可<br>能先于a变量。如果是一个内联方法，编译器可能更甚一步<br>将该方法的指令与其他语句进行重排序<br>2 处理器可能会对语句所对应的机器指令进行重排序之后<br>在执行，甚至并发地去执行<br>3 内存系统(由高速缓存控制单元组成)可能会对变量所对<br>应的内存单元的写操作指令进行重排序。重排之后的写<br>操作可能会对其他的计算/内存操作造成覆盖<br>4 编译器，处理器已经内存系统可能会让两条语句的机器<br>指令交错。比如在32位机器上，b变量的高位字节先被写入<br>，任何是a变量，紧接着才会是b变量的低位字节<br>5 编译器，处理器以及内存系统可能会导致两个变量的内<br>存单元在(如果有的话)连续的check调用之后的某个时刻<br>才更新，而以这种方式保存相应的值(如在CPU寄存器中)<br>仍会得到预期的结果(check不会返回false)    </p>
<p>在串行执行的语言中，只要程序执行遵循串行的语义，如<br>上几种行为就不会有任何影响。在一段简短的代码块中，<br>串行执行程序不会依赖于代码的内部执行细节，因此如上<br>的几种行为可以随意控制代码。这样就为编译器和计算机<br>硬件提供了基本的灵活性。基于此，在过去的数十年内<br>很多技术(CPU的流水线操作，多级缓存、读写平衡，寄存<br>器分配等等)应运而生，为计算机处理速度的大幅提升奠定<br>了基础。这些操作的类似串行执行的特性可以让开发人员<br>无线知道其内部发了什么</p>
<p>然而这些情况在并发编程中就完全不一样了，上面的代码<br>在并发过程中，当一个线程调用check方法的时候完全有可<br>能另外一个线程正在执行set方法，这种情况下check方法<br>就会将上面提到的优化操作过程暴露出来。如果上述任意<br>一个操作发生，那么check方法就有可能返回false。例如<br>check方法读取long类型的变量b的时候可能得到的既不是<br>0也不是-1，而是一个被写入一半的值。另一种情况，set<br>方法中的语句的乱序执行有可能导致check方法读取变量<br>b的值时候是-1，然而读取变量a时却依然是0</p>
<p>换句话说，不仅是并发执行会导致问题，而且在一些优化<br>操作(比如指令重排)进行之后也会导致代码执行结果和原<br>代码中的逻辑有所出入。由于编译器和运行时技术的成熟<br>及多处理器的普及，这种现象就变得越来越普遍。    </p>
<p>CPU的寄存器不呢干杯另一个CPU直接访问，这种模型必须<br>考虑到某个线程无法得知被另一个线程操作变量的值的<br>情况。这种情况下不仅仅存在于多处理器环境上，在单核<br>CPU环境里，因为编译器和处理器的不可预测的行为也可能<br>导致同样的情况</p>
<p>Java内存模型仅仅保证了代码指令与变量操作的有序性，<br>大多数规则都只是指出什么时候变量值应该在内存和线程<br>工作内存之间传输</p>
<p>1 原子性= 在Java内存模型中<br>这些规则需声明仅适用于实例变量和静态变量，也包括数<br>组元素，但不包括方法中的局部变量的内存单元的简单读<br>写操作<br>2 可见性= 一个线程执行的结果是另一个线程是可见的。<br>3 有序性= 某个线程的操作结果对其他线程来看是无序的</p>
<h1 id="原子性"><a href="#原子性" class="headerlink" title="原子性"></a>原子性</h1><p>除了long型字段和double型字段外，Java内存模型确保访<br>问任意类型字段所对应的内存单元都是原子的。这包括引<br>用其他对象的引用类型的字段。此外，volatile long 和<br>vlolatile double 也具有原子性。</p>
<p>当在一个表达式中使用一个non-long或者non-double型字<br>段时，原子性可以确保你将获得这个字段的初始值或者某<br>个线程对这个字段写入之后的值；但不会是两个或更多线<br>程在同一时间对这个字段写入之后产生混乱的结果值，但<br>是原子性不能确保你获得的是任意线程写入之后的最新值<br>因此，原子性保证通常对并发程序设计的影响很小</p>
<h1 id="可见性"><a href="#可见性" class="headerlink" title="可见性"></a>可见性</h1><p>只有在下列情况时，一个线程对字段的修改才能确保对另<br>一个线程可见：<br>一个线程释放一个锁之后，另一个读线程随后获取了同<br>一个锁。本质上，线程释放锁是会将强制刷新工作内存中<br>的脏数据到主内存中，获取一个锁将强制线程装载字段的<br>值。锁提供对一个同步方法或块的互斥性执行，线程执行<br>获取锁和释放锁时，所有对字段的访问的内存效果都是已<br>定义的。</p>
<p>注意同步的双重含义：锁提供高级同步协议，同时在线程<br>执行同步方法或块时，内存系统保存值的一致性。这说明<br>与顺序程序设计相比较，并发程序设计与分布式程序设计<br>更加类似。同步的第二个特性可以视为一种机制：一个线<br>程在运行已同步方法时，它将发送和或接收其他线程在<br>同步方法中对变量所做的修改</p>
<p>如果把一个字段声明为volatile类型，线程对这个字段<br>写入之后，在执行后续的内存访问之前，线程必须刷新<br>这个字段且让这个字段对其他线程可见。每次对volatile<br>字段的读访问，都要重新装载字段的值</p>
<p>一个线程首次访问一个对象的字段，它将读到这个字段的<br>初始值或被某个线程写入后的值。此外，把未构造完成的<br>对象的引用暴露给某个线程，这是一个错误的做法。在<br>构造函数内部开始一个新线程也是危险的，特别是这个类<br>可能被子类话。Thread.start有如下的内存效果：调用<br>start方法的线程释放锁，随后开始执行的新线程获取了<br>这个锁。如果在子类构造函数执行之前，可运行的超类<br>调用了new Thread(this).start()， 放run方法执行时，<br>对象很可能还没有完全初始化。同样，如果你创建且开始<br>一个线程T，这个线程使用了在执行start之后才创建的<br>一个对象x,你不能确信X的值字段值将能对线程T可见。<br>除非你把所有用到X的引用的方法做同步。如果可行的恶<br>化， 你可以在开始T线程之前创建X</p>
<p>线程终止时，所有写过的变量值都要刷新到主内存中。<br>比如一个线程使用Thread.join来终止另一个线程。那么<br>第一个线程肯定能看到第二个线程对变量值的修改。</p>
<p>注意，在同一个线程的不同方法之间传递对象的引用，永<br>远不会出现内存可见性问题。内存模型确保上述操作最终<br>会发生，一个线程对一个特定字段的特定更新，最终将会<br>对其他线程可见，但这个最终可能是很长一段时间。线程<br>之间没有同步时，很那保证对这个字段的值能在多线程<br>之间保存一直(指写线程对字段的写入理解对读线程可见)<br>特别是，如果字段不是volatile或没有通过同步来访问<br>这个字段，在一个循环中等待其他线程对这个字段的写入<br>，这种情况总是错误的。</p>
<p>在缺乏同步的情况下，模型还允许不一致的可见性。如果<br>得到一个对象的一个字段最新值，同时得到这个对象的其<br>它字段的过期的值。同样，可能读到一个引用变量的最新<br>值，但读取到这个引用暴露引用的对象的字段的过期值。<br>不管怎样，线程质之间的可见性并不总是失效，内存模型<br>仅仅是允许这种失效发生而言。因此，技术多个线程之间<br>没有使用同步，也不保证一定会方式内存可见性问题</p>
<h1 id="有序性"><a href="#有序性" class="headerlink" title="有序性"></a>有序性</h1><p>有序性规则表现在以下两种场景：线程内和线程间</p>
<p>从某个线程的角度看方法的执行，指令会按照一种串行的<br>方式执行，已经应用于顺序编程语言</p>
<p>这个线程观察到其他线程并发地执行非同步的代码时，任<br>何代码都有可能交叉执行。唯一起作用的约束是：对于同<br>步方法，同步块已经volatile字段的操作仍维持相对有序</p>
<p>再次提醒，这些仅是最小特性的规则。具体到任何一个<br>程序或平台上，可能存在更严格的有序性规则。所以不能<br>依赖它们。</p>
<p>仅当某一时刻只有一个线程操作变量时，线程内的执行表<br>现为串行。当多线程同时运行在非同步的代码里进行公用<br>字段的读写时，会形成一种执行模式。在这种模式下，代<br>码会任意交叉执行，原子性和可见性会失效，以及产生<br>竞态条件。这时线程执行不再表现为串行</p>
<h1 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h1><p>从原子性、可见性和有序性的角度分析，声明为volatile<br>字段的作用相当于一个类通过get/set同步方法保护普通<br>字段。</p>
<p>与使用synchronized相比，声明一个volatile字段的区别在于没有涉及到锁操作。但特别的是对volatile字段进行<br>++这样的读写操作不会被当做原子操作执行。  另外，有<br>序性可可见性仅对volatile字段进行一次读取或更新操作<br>起作用。声明一个引用变量为volatile，不能保证通过该<br>引用变量访问到非volatile变量的可见性。同理，声明一<br>哥数组变量为volatile不能保证数组内元素的可见性。vo<br>latile的特性不能在数组内传递，因为数组内里的元素<br>不能被声明为volatile</p>
<p>由于没有涉及到锁操作，声明volatile字段很可能比使用<br>同步的开销更低，但如果在方法内频繁访问volatile字段<br>很可能导致更低的性能，这时还不如锁住整个方法</p>
<p>volatile使用情况<br>1 该字段不遵循其他字段的不变式<br>2 对字段的写操作不依赖于当前值<br>3 没有线程违反预期的语义写入非法值<br>4 读操作不依赖其他非volatile字段的值</p>

            <div class="clearfix"></div>
            <hr class="nogutter">
        </div>
        <nav class="pagination" role="pagination">
    
    <a class="pull-left" href="/2017/10/30/DougLea-任务取消/" style="float: left;">
        ← DougLea_任务取消
    </a>
    
    
    <a class="pull-right" href="/2017/10/30/condition/">
        condition →
    </a>
    
</nav>

        <div class="duoshuo">


</div>
    </div>
</section>


      
<!-- ============================ Footer =========================== -->

<footer>
    <div class="container">
            <div class="copy">
                <p>
                    &copy; 2014<script>new Date().getFullYear()>2010&&document.write("-"+new Date().getFullYear());</script>, Content By changecode. All Rights Reserved.
                </p>
                <p>Theme By <a href="//go.kieran.top" style="color: #767D84">Kieran</a></p>
            </div>
            <div class="social">
                <ul>
                    
                    <li><a href="https://github.com/" title="Github" target="_blank"><i class="icon-github"></i></a>&nbsp;</li>
                    
                    
                    
                    <li><a href="https://www.facebook.com/" title="Facebook" target="_blank"><i class="icon-facebook"></i></a>&nbsp;</li>
                    
                    
                    <li><a href="https://google.com/" title="Google-Plus" target="_blank"><i class="icon-google-plus"></i></a>&nbsp;</li>
                    
                    
                </ul>
            </div>
            <div class="clearfix"> </div>
        </div>
</footer>

<!-- ============================ END Footer =========================== -->
      <!-- Load our scripts -->
<!-- Resizable 'on-demand' full-height hero -->
<script type="text/javascript">
    var resizeHero = function () {
        var hero = $(".cover,.heightblock"),
            window1 = $(window);
        hero.css({
            "height": window1.height()
        });
    };

    resizeHero();

    $(window).resize(function () {
        resizeHero();
    });
</script>
<script src="/js/plugins.min.js"></script><!-- Bootstrap core and concatenated plugins always load here -->
<script src="/js/jquery.flexslider-min.js"></script><!-- Flexslider plugin -->
<script src="/js/scripts.js"></script><!-- Theme scripts -->


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$('#intro').find('img').each(function(){
  var alt = this.alt;

  if (alt){
    $(this).after('<span class="caption" style="display:none">' + alt + '</span>');
  }

  $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox" rel="gallery" />');
});
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

<!-- Initiate flexslider plugin -->
<script type="text/javascript">
    $(document).ready(function($) {
      (function(){
        console.log('font');
        var getCss = function(path) {
          var head = document.getElementsByTagName('head')[0];
          link = document.createElement('link');
          link.href = path;
          link.rel = 'stylesheet';
          link.type = 'text/css';
          head.appendChild(link);
        };
        getCss('https://fonts.googleapis.com/css?family=Montserrat:400,700');
        getCss('https://fonts.googleapis.com/css?family=Open+Sans:400,600');
      })();
      $('.flexslider').flexslider({
        animation: "fade",
        prevText: "",
        nextText: "",
        directionNav: true
      });
    });
</script>

</body>
</html>
